define(["require","exports","tslib","external/react","external/lodash","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/analytics","modules/clean/annotations/annotation","modules/clean/comments/action_creators_helpers","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/logged_out_utils","modules/clean/comments/models/comment_activity","modules/clean/comments/revisions","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/file_activity/models/immutability_helper","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_viewer/utils","modules/clean/react/modal","modules/clean/storage","modules/constants/comments_panel","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/comments/legacy_redux_integration"],function(t,e,n,o,i,a,r,s,c,m,u,l,d,v,y,g,f,_,C,p,h,x,I,A,b,S,w,K,L,V){"use strict";function O(){var t=g.state.actorId,e=g.state.shouldShowOnboarding,n=g.state.viewing,o=n.context,i=n.file,a=I.getFileViewerInterfaceType(o,i&&i.preview_type);if(null!=t&&null!=a){if(null==e)return _.shouldShowCommentingOnboarding({actorId:t}).then(function(t){if(u.setShouldShowOnboarding(t),t)return Q()}).catch(function(){});if(e===!0)return Q()}}function T(t,e){return void 0!==t&&null!==t?e(t):void 0}o=n.__importStar(o),i=n.__importStar(i),r=n.__importStar(r),m=n.__importStar(m),d=n.__importStar(d),f=n.__importStar(f),_=n.__importStar(_),h=n.__importDefault(h);var k=function(t,e){var n=C.getInstance().commitOptimisticUpdate(e);return t.then(function(t){return C.getInstance().rebase(n),t}),t.catch(function(t){return C.getInstance().rollbackOptimisticUpdate(n),Promise.reject(t)})},E=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity,o=g.state.activity.activity_key,i=e===o?null:e,a=n.comment,r=a.raw_comment_text,s=a.comment_metadata,c=_.addComment({actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,commentActivityKey:i,text:r,metadata:null!=s?s.toDict():void 0,oref:g.state.oref}),m=C.getInstance().commitOptimisticUpdate(function(t){return t.appendComment(e,n)});return c.then(function(t){var n=C.getInstance();return n.rollbackOptimisticUpdate(m),n.rebase(function(n){return n.appendComment(e,t)})}),[c,m]},U=function(t,e){return p.merge(t,{status:"FAILED",activity_key:e})},B=function(t){var e=t.targetActivityKey,n=t.body,o=t.annotation,i=f.getActivityUser(g.state.actorId);g.state.activity.activity_key;var a=null!=n.text?n.text:"",r=m.buildCommentMetadata(n,o),s=v.CommentActivity.createLocalInstance({commenter:i,rawCommentText:a,metadata:r,status:"POSTING"}),c=Array.from(E({targetActivityKey:e,pendingCommentActivity:s})),u=c[0],l=c[1];return u.catch(function(t){var n=C.getInstance();return n.rollbackOptimisticUpdate(l),n.commitOptimisticUpdate(function(t,n){var o=U(s,n);return t.appendComment(e,o)}),Promise.reject(t)}),[s,u]},D=function(t,e,n){var o=f.getActivityUser(g.state.actorId),i=g.state.activity.activity_key;if(!o.is_signed_in)return d.saveActionCreator({name:t,fileActivityKey:i,args:e}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:i,variant:x.CommentsSharedLinkSignupModals.POST_COMMENT_VARIANT}),d.logSignUpModal({fileActivityKey:i,commentActivityKey:n,originType:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON}),b.LocalStorage.set("tmp-file-comment",null),!1;if(!o.is_email_verified){var s=a.EmailVerification.get_for_user(o);return a.EmailVerification.set_should_use_simple_ui(!1),s.show_verify_modal(null,r.ADD_COMMENT),!1}return!0},P=function(t){var e=t.targetActivityKey,n=t.pendingCommentActivity;s.CommentsVortexLogger.log("retry-post-attempt"),C.getInstance().rollbackOptimisticUpdate(n.activity_key),n=n.setStatus("POSTING");var o=Array.from(E({targetActivityKey:e,pendingCommentActivity:n})),i=o[0],a=o[1];return i.catch(function(t){var o=C.getInstance();return o.rollbackOptimisticUpdate(a),o.commitOptimisticUpdate(function(t){var o=U(n,a);return t.appendComment(e,o)}),Promise.reject(t)}),u.addedComment(),i.then(function(){return s.CommentsVortexLogger.log("retry-post-success")})},N=function(t){if(D("addFileComment",[t])){s.CommentsVortexLogger.log("add-comment-attempt");var e=g.state.activity.activity_key,n=Array.from(B({targetActivityKey:e,body:t})),o=n[1];return u.addedComment(),o.then(function(){return s.CommentsVortexLogger.log("add-comment-success")})}},R=function(t){var e=g.state.createAnnotation.annotation;if(null!=e&&D("addInlineAnnotation",[t])){s.CommentsVortexLogger.log("add-annotation-attempt");var n=Array.from(B({targetActivityKey:g.state.activity.activity_key,body:t,annotation:e})),o=n[0],i=n[1];return M(o),u.addedComment(),i.then(function(){return s.CommentsVortexLogger.log("add-annotation-success")})}},F=function(t){var e=t.targetActivityKey,n=t.body;if(D("addReply",[{targetActivityKey:e,body:n}])){s.CommentsVortexLogger.log("add-reply-attempt");var o=Array.from(B({targetActivityKey:e,body:n})),i=o[0],a=o[1];return M(i),u.addedComment(),a.then(function(){return s.CommentsVortexLogger.log("add-reply-success")})}},M=function(t){return i.defer(function(){return H({activityKey:t.activity_key,expandConversation:!1})})},G=function(t){var e=t.commentActivityKey;s.CommentsVortexLogger.log("delete-comment-attempt"),w.assert(null!=g.state.activity.findCommentByKey(e),"Comment activity to delete does not exist: "+e);var n=_.deleteComment({actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,commentActivityKey:e,oref:g.state.oref});return k(n,function(t){return t.purgeCommentByKey(e)}),n.then(function(){return s.CommentsVortexLogger.log("delete-comment-success")})},Y=function(t){var e,n=t.commentActivityKey,o=t.resolved;s.CommentsVortexLogger.log("set-resolved-attempt");var i=g.state.activity.findCommentByKey(n);w.assert(null!=i,"Comment activity to resolve/unresolve does not exist: "+n);var a=_.updateResolveComment({actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,commentActivityKey:n,resolved:o,oref:g.state.oref});return e=i.comment.resolved?function(t){return t.unresolveCommentByKey(n)}:function(t){return t.resolveCommentByKey(n)},k(a,e),a.then(function(){return s.CommentsVortexLogger.log("set-resolved-success")})},j=function(t){var e,n=t.enabled;s.CommentsVortexLogger.log("set-enabled-attempt");var o=_.updateCommentSetting({actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,enableComment:n,oref:g.state.oref});return e=g.state.activity.feedback_off?function(t){return t.enableCommenting()}:function(t){return t.disableCommenting()},k(o,e),n?u.enableCommenting():u.disableCommenting(),o.then(function(){return s.CommentsVortexLogger.log("set-enabled-success")})},W=function(t){var e=t.subscribed,n=f.getActivityUser(g.state.actorId),o=g.state.activity.activity_key;if(!n.is_signed_in)return d.saveActionCreator({name:"setCommentSubscribed",fileActivityKey:o,args:arguments.slice()}),l.CommentsEvents.emit("show-sign-up-modal",{fileActivityKey:o,variant:x.CommentsSharedLinkSignupModals.SUBSCRIBE_VARIANT}),void d.logSignUpModal({fileActivityKey:o,originType:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON});if(!n.is_email_verified){var i=a.EmailVerification.get_for_user(n);return a.EmailVerification.set_should_use_simple_ui(!1),void i.show_verify_modal(null,r.SUBSCRIBE_TO_COMMENTS)}s.CommentsVortexLogger.log("set-subscribed-attempt");var c=_.updateFileActivitySubscription({actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,subscribed:e,oref:g.state.oref});return e?c.then(function(){return L.Notify.success(K._("You have been subscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}):c.then(function(){return L.Notify.success(K._("You have been unsubscribed."))}).catch(function(t){return L.Notify.error(K._("We failed to unsubscribe you.")),Promise.reject(t)}),c.then(function(){return s.CommentsVortexLogger.log("set-subscribe-success")})},q=function(t){var e=g.state.activity,n=e.findConversationByKey(t),o=f.getActivityUser(g.state.actorId);if(null!=n&&o.is_signed_in){var a=function(t){return!(t.is_pending||t.is_seen)},r=n.comment_activities.filter(a);if(a(n)&&r.push(n),r.length>0){s.CommentsVortexLogger.log("mark-conversation-seen-attempt");var c=i.map(r,"activity_key"),m=_.markCommentSeenBatch({isBackgroundRequest:!0,actorId:g.state.actorId,context:g.state.viewing.context,contextData:g.state.viewing.contextData,commentActivityKeys:c});return k(m,function(t){return e.markCommentSeenByKeyBatch(c)}),m.then(function(){return s.CommentsVortexLogger.log("mark-conversation-seen-success")})}}},H=function(t){var e=t.activityKey,n=t.expandConversation;return l.CommentsEvents.emit("reveal-comment-in-pane",{activityKey:e,expandConversation:n})},z=function(t){var e=g.state.activity;if(null!=e){var n=e.findConversationByKey(t);if(T(null!=n?n.comment.comment_metadata:void 0,function(t){return t.annotation})){var o=n.comment.comment_metadata,i=o.annotation,a=o.revision,r=c.Annotation.createAnnotationFromDict(i);return null!=a&&u.switchRevision({revision:a,commentActivity:n}),l.CommentsEvents.emit("reveal-annotation",{page:r.getFirstPdfPage(),commentActivity:n})}}},J=function(t){var e=g.state.activity,n=f.getActivityUser(g.state.actorId);if(g.state.viewing.file&&e&&t&&y.isRevisionOlderThan(e.latest_revision,t.latest_revision)){var o=y.getFileWithRevision(g.state.viewing.file,t.latest_revision);V.reduxSaveForwardRevision(o)}if(u.receiveFileActivity(t),n.is_signed_in&&null==e&&null!=t&&d.replayActionCreators({actionCreators:et,fileActivityKey:t.activity_key}),g.state.isPreviewReady&&null==e)return l.CommentsEvents.emit("preview-and-comments-ready")},Q=function(){var t=g.state.actorId,e=o.createElement(h.default,{onOpen:function(){return u.setShouldShowOnboarding(!1),_.markCommentingOnboardingSeen({actorId:t}).catch(function(){})}});return A.Modal.showInstance(e)},X=function(){if(s.CommentsVortexLogger.log("show-comments-attempt"),g.areCommentsHidden())return $(!0),u.showComments(),s.CommentsVortexLogger.log("show-comments-success")},Z=function(){if(s.CommentsVortexLogger.log("hide-comments-attempt"),!g.areCommentsHidden())return $(!1),u.hideComments(),s.CommentsVortexLogger.log("hide-comments-success")},$=function(t){return null!=g.state.actorId?_.setCommentingPaneVisibility({actorId:g.state.actorId,shouldShow:t}):_.setSessionCommentingPaneVisibility({shouldShow:t})},tt=function(){return _.setShowCommentsTutorial({actorId:g.state.actorId,shouldShow:!1})};l.CommentsEvents.on("file-activity-updated",J);var et=i.assignIn({},u,{addReply:F,addFileComment:N,addInlineAnnotation:R,retryPostingComment:P,deleteComment:G,setCommentResolved:Y,setCommentSubscribed:W,setCommentsEnabled:j,markConversationSeen:q,showOnboardingIfNecessary:O,revealCommentInPane:H,revealAnnotationInPreview:z,markCommentsTutorialAsDone:tt,showComments:X,hideComments:Z});return et});
//# sourceMappingURL=action_creators.min.js-vflGZC8xK.map